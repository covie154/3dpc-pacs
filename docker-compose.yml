services:

  # ── TLS reverse proxy ──────────────────────────────────────────────────────
  nginx:
    image: orthancteam/orthanc-nginx:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      ENABLE_HTTPS: "false"
      # NB: Set temporalily to FALSE for testing. Please re-enable for prod.
      # Tell the nginx image which upstream paths belong to which backend.
      # orthancteam/orthanc-nginx conventions:
      ORTHANC_ROOT: /orthanc/
      ORTHANC_PEER_1_ROOT: /shares/
      ORTHANC_PEER_1_HOST: orthanc-for-shares
      ORTHANC_PEER_1_PORT: "8042"
    volumes:
      - certbot-www:/var/www/certbot:ro
      - certbot-conf:/etc/letsencrypt:ro
    depends_on:
      - orthanc
      - orthanc-for-shares

  # ── Let's Encrypt cert management ─────────────────────────────────────────
  certbot:
    image: certbot/certbot:latest
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-conf:/etc/letsencrypt
    # Default entrypoint is fine; invoked on-demand via `docker compose run`.

  # ── PostgreSQL index DB ────────────────────────────────────────────────────
  # Both Orthanc instances share this DB for metadata. Actual DICOM files
  # live on the orthanc-storage volume; PostgreSQL stores the index only.
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    # Raise max_connections above the default 100.
    # Each Orthanc instance uses a pool of ORTHANC__POSTGRESQL__CONNECTIONS_COUNT
    # connections (set to 10 below). Two instances = 20, plus a few for psql/admin.
    command: postgres -c max_connections=50
    environment:
      POSTGRES_DB: orthanc
      POSTGRES_USER: orthanc
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orthanc"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ── Main Orthanc (staff-facing) ────────────────────────────────────────────
  orthanc:
    image: orthancteam/orthanc:latest-full
    restart: unless-stopped
    ports:
      - "4242:4242"   # DICOM — open to the network
      # 8042 is NOT published; nginx proxies internally
    environment:
      # Registered user injected as env var so the password never lives in
      # a config file that might be committed.
      ORTHANC__REGISTERED_USERS: |
        {"${ORTHANC_ADMIN_USER}": "${ORTHANC_ADMIN_PASSWORD}"}
      # Auth-service shared secret
      ORTHANC__AUTHORIZATION__WEB_SERVICE_PASSWORD: "${AUTH_SERVICE_WEB_PASSWORD}"
      # Used for ${PUBLIC_OHIF_ROOT} substitution inside orthanc.json
      PUBLIC_OHIF_ROOT: "${PUBLIC_OHIF_ROOT}"
      # PostgreSQL index (replaces SQLite; fixes concurrent-access errors)
      ORTHANC__POSTGRESQL__HOST: postgres
      ORTHANC__POSTGRESQL__DATABASE: orthanc
      ORTHANC__POSTGRESQL__USERNAME: orthanc
      ORTHANC__POSTGRESQL__PASSWORD: "${POSTGRES_PASSWORD}"
      ORTHANC__POSTGRESQL__ENABLE_INDEX: "true"
      ORTHANC__POSTGRESQL__ENABLE_STORAGE: "false"
      ORTHANC__POSTGRESQL__CONNECTIONS_COUNT: "10"
    volumes:
      - ./config/orthanc/orthanc.json:/etc/orthanc/orthanc.json:ro
      - orthanc-storage:/var/lib/orthanc/db
    depends_on:
      postgres:
        condition: service_healthy
      orthanc-auth-service:
        condition: service_started

  # ── Shares Orthanc (token-gated, no login required) ───────────────────────
  orthanc-for-shares:
    image: orthancteam/orthanc:latest-full
    restart: unless-stopped
    # No published ports — reachable only via nginx
    environment:
      ORTHANC__AUTHORIZATION__WEB_SERVICE_PASSWORD: "${AUTH_SERVICE_WEB_PASSWORD}"
      # PostgreSQL index (same DB as main instance)
      ORTHANC__POSTGRESQL__HOST: postgres
      ORTHANC__POSTGRESQL__DATABASE: orthanc
      ORTHANC__POSTGRESQL__USERNAME: orthanc
      ORTHANC__POSTGRESQL__PASSWORD: "${POSTGRES_PASSWORD}"
      ORTHANC__POSTGRESQL__ENABLE_INDEX: "true"
      ORTHANC__POSTGRESQL__ENABLE_STORAGE: "false"
      ORTHANC__POSTGRESQL__CONNECTIONS_COUNT: "10"
    volumes:
      - ./config/orthanc-shares/orthanc.json:/etc/orthanc/orthanc.json:ro
      - orthanc-storage:/var/lib/orthanc/db   # shared DICOM file storage
    depends_on:
      postgres:
        condition: service_healthy
      orthanc-auth-service:
        condition: service_started

  # ── Auth service (token issue + validation) ────────────────────────────────
  orthanc-auth-service:
    image: orthancteam/orthanc-auth-service:latest
    restart: unless-stopped
    # No published ports — internal only
    environment:
      SECRET_KEY: "${AUTH_SERVICE_SECRET_KEY}"
      # HTTP Basic Auth that Orthanc uses when calling auth-service
      USERS: |
        {"${AUTH_SERVICE_WEB_USER}": "${AUTH_SERVICE_WEB_PASSWORD}"}
      # Public roots used when constructing share link URLs
      PUBLIC_ORTHANC_ROOT: "${PUBLIC_ORTHANC_ROOT}"
      PUBLIC_LANDING_ROOT: "${PUBLIC_LANDING_ROOT}"
      PUBLIC_OHIF_ROOT: "${PUBLIC_OHIF_ROOT}"
    volumes:
      - ./config/auth-service/permissions.json:/orthanc_auth_service/permissions.json:ro


volumes:
  orthanc-storage:
  postgres-data:
  certbot-www:
  certbot-conf:
